--@name cum_framework/CUM differential
--@author ced555
--@server
--@model models/props_pipes/pipe02_tjoint01.mdl

-- SETTINGS --
local finaldrive = 5
local ratios = {5,3,2,2.5,2,1.75}
-- SETTINGS --

local wheelrpm = 0
local driving = 1
local ratio = 0
local gear = 1

local clutch = 0
local brakes = 0
local wheels = {}

local wheelspeeds = {0}
local chiphys = chip():getPhysicsObject()
local torque = 0
local engine = 0
local wheelholos = {}
if SERVER then
    outputtypes = {"number","number","number"}
    outputs = {"WheelRPM","Driving","Ratio"}
    wire.adjustOutputs(outputs,outputtypes,nil)
    inputs = {"Engine","Clutch","Brakes","Wheels","Gear"}
    inputtypes = {"wirelink","number","number","array","number"}
    description = {"Engine chip","0 or 1","Brake force, 0-100 or more","Link to and adv entity marker"}
    wire.adjustInputs(inputs,inputtypes,description)
    
    chip():setPhysicsUpdateListener( function()
        if engine then
            torque = engine["Torque"] * ratio
            for i = 1,#wheels do
                local wheel = wheels[i]
                local x = wheel:localToWorldVector( wheel:getAngleVelocity() ):dot( wheelholos[i]:getForward() )/6
                wheelspeeds[i] = math.abs(x)
                
                local brakeLimit = brakes * 1000
                
                local inertia = math.abs( wheel:localToWorldVector( wheel:getInertia() ):dot( wheelholos[i]:getForward() ) )

                if torque ~= 0 or brakes ~= 0 then
                    wheel:applyTorque( wheelholos[i]:getForward() * torque * driving + wheelholos[i]:getForward() /#wheels * ( inertia * 5 * -math.clamp( x, -brakeLimit, brakeLimit ) ) )
                end
                
        end
        wheelrpm=math.max(unpack(wheelspeeds))
        --printTable(wheelspeeds)
        
        wire.triggerOutput(chip(),"WheelRPM",wheelrpm)
        wire.triggerOutput(chip(),"Driving",driving)
        else
            torque = 0
        end
    end )
    
    hook.add("Input", "inputupdate", function(Input, value) 
        if Input == "Clutch" then
            driving = value ~= 0 and 0 or 1
        end
        if Input == "Brakes" then
            brakes = math.abs(value)
        end
        if Input == "Wheels" then
            wheels = value
            table.empty(wheelspeeds)
            for i=1,#wheels do 
                local wheel = wheels[i]
                local holo = hologram.create(wheel:getPos(),chip():getAngles(),"models/props_c17/doll01.mdl")
                holo:setColor(Color(255,255,255,0))
                
                wheelholos[i] = holo
                holo:setParent(wheel)
            end
        end
        if Input == "Gear" then
            gear = math.clamp(value,1,#ratios)
            ratio = ratios[math.round(gear)] * finaldrive
            wire.triggerOutput(chip(),"Ratio",ratio)
        end
        if Input == "Engine" then
            engine = value
        end
    end)
end

