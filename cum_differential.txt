--@name cum_framework/CUM engine
--@author
--@server
--@model models/props_c17/SuitCase001a.mdl

-- Engine Values --
local torquemin = 125
local torquemax = 275
local idlerpm = 900
local maxrpm = 8000
local flywheelweight = 0.06
local slope = (torquemax - torquemin)/(maxrpm-idlerpm)
local inertia = flywheelweight* 3.1416^2

-- Input values --
local Throttle = 0
local Active = 0
local Gearbox = 0
-- output values --
local RPM = 0
local Torque = 0
-- misc values --
local flywheelSpeed = 0
local driving = 0



if SERVER then
    engine = hologram.create(chip():localToWorld(Vector(0,1.5,0)),chip():localToWorldAngles(Angle(-90,0,0)),"models/props_c17/TrapPropeller_Engine.mdl",Vector(0.75,0.75,1))
    engine:setParent(chip())
    local enginesound = sound.create(chip(),"Airboat_engine_idle")
    enginesound:setVolume(1,nil)
    enginesound:play()
    chip():setColor(Color(255,255,255,1))
    inputs = {"Throttle" , "Active" , "Gearbox"}
    inputtypes = {"number","number","wirelink"}
    wire.adjustInputs(inputs, inputtypes, nil)
    
    outputs = {"RPM" , "Torque"}
    outputstypes = {"number","number"}
    wire.adjustOutputs(outputs, outputstypes, nil)
    
    hook.add("Input", "inputupdate", function(Input, value) 
        if Input == "Throttle" then
           Throttle = math.clamp(value,0,100)
        end
        if Input == "Active" then
           Active = math.clamp(value,0,1)
        end
        if Input == "Gearbox" then
           Gearbox = value 
        end
        
        end)
        
    hook.add("Tick", "clock", function()
        Torque = RPM * slope * Throttle/100 * (RPM < maxrpm and 1 or 0) 
        enginesound:setPitch(RPM/maxrpm*125)
        if Gearbox then
            driving = Gearbox["Driving"]
            wheelrpm = Gearbox["WheelRPM"]
            ratio = Gearbox["Ratio"]
        else
            driving = 0
        end
        
        if driving == 0 then
            local drag = torquemax * ((RPM-idlerpm)/maxrpm * tonumber(100-Throttle)/100)/inertia
            RPM = math.clamp(RPM+Torque/inertia - drag,idlerpm,maxrpm)*Active
        elseif driving == 1 then
            RPM = math.clamp(idlerpm + wheelrpm * ratio,idlerpm,maxrpm) * Active
        end
        wire.triggerOutput(chip(),"RPM",RPM)
        wire.triggerOutput(chip(),"Torque",Torque)
    end)
end