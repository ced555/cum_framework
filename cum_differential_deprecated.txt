--@name cum_framework/CUM differential
--@author ced555
--@server
--@model models/props_pipes/pipe02_tjoint01.mdl


local function tonum( bool )
if bool == true then return 1
else return 0 end
end


-- SETTINGS --
local finaldrive = 5
local ratios = {-5,5,3,2,2.5,2,1.5,1,0.75}
-- SETTINGS --

local gbrpm = 0
local driving = 1
local ratio = 0
local gear = 1

local clutch = 0
local brakes = 0
local wheels = {}

local wheelspeeds = {0}
local torque = 0
local engine = 0
local wheelholos = {}
if SERVER then
    local outputtypes = {"number","number","number",}
    local outputs = {"GearboxRPM","Driving","Ratio",}
    wire.adjustOutputs(outputs,outputtypes,nil)
    local inputs = {"Engine","Clutch","Brakes","Wheels","Gear"}
    local inputtypes = {"wirelink","number","number","array","number"}
    local description = {"Engine chip","0 or 1","Brake force, 0-100 or more","Link to and adv entity marker"}
    wire.adjustInputs(inputs,inputtypes,description)
    
    timer.create("clock",1/16,0, function()
        if engine then
            torque = engine["Torque"] * ratio * (1-clutch)*4.25 --reduced it from every tick (every 1/66) to 1/16 so i had to buff it
            --print(torque)
            gbrpm = 0
            for i = 1,#wheels do
                local wheel = wheels[i]
                local x = wheel:localToWorldVector( wheel:getAngleVelocity() ):dot( wheelholos[i]:getForward() )/6
                wheelspeeds[i] = math.abs(x)
                local brakeLimit = brakes * 1000
                local inertia = math.abs( wheel:localToWorldVector( wheel:getInertia() ):dot( wheelholos[i]:getForward() ) )
                gbrpm = gbrpm + wheelspeeds[i] * math.abs(ratio)
                wheel:applyTorque( wheelholos[i]:getForward() * torque * driving + wheelholos[i]:getForward()* ( inertia * 5 * -math.clamp( x, -brakeLimit, brakeLimit ) ) )
            end
        gbrpm = gbrpm/#wheels
        wire.triggerOutput(chip(),"GearboxRPM",gbrpm)
        wire.triggerOutput(chip(),"Driving",driving)
        else
            torque = 0
        end
    end )
    
    hook.add("Input", "inputupdate", function(Input, value) 
        if Input == "Clutch" then
            driving = tonum(not(value >= 1)) * #wheels
            clutch = value
        end
        if Input == "Brakes" then
            brakes = math.abs(value)
        end
        if Input == "Wheels" then
            wheels = value
            table.empty(wheelspeeds)
            driving =  #wheels
            for i=1,#wheels do 
                local wheel = wheels[i]
                local holo = hologram.create(wheel:getPos(),chip():getAngles(),"models/props_c17/doll01.mdl")
                holo:setColor(Color(255,255,255,155))
                wheelholos[i] = holo
                holo:setParent(wheel)
            end
        end
        if Input == "Gear" then
            gear = math.clamp(value,1,#ratios)
            ratio = ratios[math.round(gear)] * finaldrive
            wire.triggerOutput(chip(),"Ratio",ratio)
        end
        if Input == "Engine" then
            engine = value
        end
    end)
end

